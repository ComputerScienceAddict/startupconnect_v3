# Database Setup Guide

## Running the Migration

To fix the "Error loading opportunities" issue, you need to run the database migration to create the opportunities table.

### Step 1: Access Supabase Dashboard

1. Go to your Supabase project dashboard
2. Navigate to the **SQL Editor** in the left sidebar

### Step 2: Run the Migration

Copy and paste the entire contents of `migration.sql` into the SQL Editor and run it.

Or run these commands one by one:

```sql
-- Create opportunities table
CREATE TABLE IF NOT EXISTS public.opportunities (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  description TEXT,
  company_name TEXT,
  location TEXT,
  remote_friendly BOOLEAN DEFAULT false,
  compensation_type TEXT,
  compensation_amount DECIMAL,
  duration TEXT,
  required_skills TEXT,
  applicants INTEGER DEFAULT 0,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Create events table
CREATE TABLE IF NOT EXISTS public.events (
  id UUID PRIMARY KEY DEFAULT extensions.uuid_generate_v4(),
  created_by UUID NOT NULL REFERENCES public.user_profiles(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  description TEXT,
  start_at TIMESTAMPTZ NOT NULL,
  end_at TIMESTAMPTZ,
  all_day BOOLEAN DEFAULT false,
  location TEXT,
  is_virtual BOOLEAN DEFAULT false,
  registration_url TEXT,
  price_cents INTEGER CHECK (price_cents IS NULL OR price_cents >= 0),
  capacity INTEGER CHECK (capacity IS NULL OR capacity >= 0),
  visibility TEXT NOT NULL DEFAULT 'public'
    CHECK (visibility = ANY (ARRAY['public','private','unlisted'])),
  status TEXT NOT NULL DEFAULT 'scheduled'
    CHECK (status = ANY (ARRAY['scheduled','cancelled','postponed'])),
  tags TEXT[],
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Create applications table
CREATE TABLE IF NOT EXISTS public.applications (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  opportunity_id UUID NOT NULL REFERENCES public.opportunities(id) ON DELETE CASCADE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  status TEXT DEFAULT 'pending',
  cover_letter TEXT,
  resume_url TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE (opportunity_id, user_id),
  CONSTRAINT applications_pkey PRIMARY KEY (id)
);

-- Add indexes
CREATE INDEX IF NOT EXISTS idx_opportunities_user_id ON public.opportunities(user_id);
CREATE INDEX IF NOT EXISTS idx_opportunities_is_active ON public.opportunities(is_active);
CREATE INDEX IF NOT EXISTS idx_opportunities_created_at ON public.opportunities(created_at);
CREATE INDEX IF NOT EXISTS idx_applications_opportunity_id ON public.applications(opportunity_id);
CREATE INDEX IF NOT EXISTS idx_applications_user_id ON public.applications(user_id);
CREATE INDEX IF NOT EXISTS idx_applications_status ON public.applications(status);

-- Enable Row Level Security
ALTER TABLE public.opportunities ENABLE ROW LEVEL SECURITY;

-- Create policies for opportunities
DROP POLICY IF EXISTS "opportunities_select_any" ON public.opportunities;
CREATE POLICY "opportunities_select_any" ON public.opportunities
  FOR SELECT USING (true);

DROP POLICY IF EXISTS "opportunities_insert_self" ON public.opportunities;
CREATE POLICY "opportunities_insert_self" ON public.opportunities
  FOR INSERT WITH CHECK (auth.uid() = user_id);

DROP POLICY IF EXISTS "opportunities_update_self" ON public.opportunities;
CREATE POLICY "opportunities_update_self" ON public.opportunities
  FOR UPDATE USING (auth.uid() = user_id);

DROP POLICY IF EXISTS "opportunities_delete_self" ON public.opportunities;
CREATE POLICY "opportunities_delete_self" ON public.opportunities
  FOR DELETE USING (auth.uid() = user_id);
```

### Step 3: Verify the Setup

After running the migration, the opportunities page should work without errors. You should see:

1. No more "Error loading opportunities" messages
2. The page loads with an empty state (since no opportunities exist yet)
3. You can create new opportunities using the "Post Opportunity" button

### Troubleshooting

If you still see errors:

1. **Check if tables exist**: Run this query in the SQL Editor:
   ```sql
   SELECT table_name FROM information_schema.tables 
   WHERE table_schema = 'public' AND table_name = 'opportunities';
   ```

2. **Check permissions**: Make sure your Supabase project has the correct RLS policies

3. **Check the console**: Look at the browser console for more detailed error messages

### Next Steps

Once the migration is complete:
1. Try creating your first opportunity
2. The opportunities page should work normally
3. You can start posting and browsing opportunities

